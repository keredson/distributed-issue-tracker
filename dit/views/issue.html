
<div ng-controller="IssueCtrl"> 

  <ol class="breadcrumb">
    <li><a href="/">home</a></li>
    <li><a href='/issues'>issues</a></li>
    <li class="active">{{issue.id}}</li>
  </ol>

  <h1 ng-hide="editorEnabled">
    {{issue.title}}
    <a href="#" ng-click="editorEnabled=!editorEnabled" class='glyphicon glyphicon-pencil'></a>
  </h1>
  <h1 ng-show="editorEnabled">
    <form name="titleform" class='form-inline' ng-submit="saveTitle()">
      <input type="text" class='form-control' ng-model="issue.title" ng-model-options="{ updateOn: 'submit' }" name="title" size=30 placeholder="Title...">
      <button type="submit" class='btn btn-primary' ng-click="titleform.title.$commitViewValue(); editorEnabled=!editorEnabled">Save</button>
      <button type="button" class='btn btn-default' ng-click="titleform.title.$rollbackViewValue(); editorEnabled=!editorEnabled">Cancel</button>
    </form>
  </h1>
  
  <p class='pull-right text-muted' style='margin-top:-.9em;'>{{issue._committed_on_human}}</p>
  <p class='text-muted' style='margin-top:-.9em;' ng-show='issue._authors.length'>
    By: <span ng-repeat="author in issue._authors">{{author}}{{$last ? '' : ','}}</span>
  </p>

  <div ng-repeat="comment in issue._comments | orderBy: '_committed_on'">
    <div class="panel panel-default panel-comment" ng-hide="{{comment.type=='commit'}}">
      <div class="panel-heading">
        <div class="dropdown pull-right" ng-show="comment._dirty">
          <a data-toggle="dropdown" class='glyphicon glyphicon-chevron-down' href="#"></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
            <li role="presentation">
              <a role="menuitem" tabindex="-1" href="#" ng-click="commit(comment)" title='Commit'>
                <span class='glyphicon glyphicon-floppy-disk'></span>
              </a>
            </li>
            <li role="presentation">
              <a role="menuitem" tabindex="-1" href="#" ng-click="comment._editing=!comment._editing" title='Edit'>
                <span class='glyphicon glyphicon-pencil'></span>
              </a>
            </li>
            <li role="presentation">
              <a role="menuitem" tabindex="-1" href="#" ng-click="revert(comment)" title='Revert'>
                <span class='glyphicon glyphicon-floppy-remove'></span>
              </a>
            </li>
          </ul>
        </div>
        <div class="dropdown pull-right" ng-hide="comment._dirty">
          <a href="#" class='glyphicon glyphicon-pencil' ng-click="comment._editing=!comment._editing" title='Edit'></a>
        </div>
        <span class='pull-right text-muted'>
          {{comment._committed_on_human ? comment._committed_on_human : '(uncommitted)'}}
        </span>
        <span ng-repeat="author in comment._authors">{{author}}{{$last ? '' : ','}}</span>
        <span ng-hide="comment._authors.length">You</span>
      </div>
      <div class="panel-body" ng-bind-html='comment._text' ng-hide='comment._editing'></div>
      <div class="panel-body" ng-show='comment._editing'>
        <form ng-submit="saveComment(comment)">
          <p>
            <textarea class='form-control' ng-model='comment.text' placeholder='Add a comment...'></textarea>
          </p>
          <p class='pull-right'>
            <button type="submit" class='btn btn-primary'>Save</button>
            <button class='btn btn-default' ng-click='comment._editing=false'>Cancel</button>
          </p>
        </form>
      </div>
    </div>
    <ul ng-show="{{comment.type=='commit'}}" class='dit-commit'>
      <li>
        <span class='pull-right text-muted'>
          {{comment._committed_on_human}}
        </span>
        <a href='/commit/{{comment.hexsha}}'><code>{{comment.message}}</code></a><br>
        <span ng-repeat="(fn, details) in comment.files" style='font-size:8pt; padding-left:4px;'>
          {{fn}}
          (<span style='color:red'>{{details.deletions}}</span>/<span style='color:green'
          >{{details.insertions}}</span>)<span ng-hide="$last">,</span>
        </span>

      </li>
    </ul>
  </div>

    
  <form name="commentform" ng-submit="addComment()">
    <p>
      <textarea class='form-control' ng-model='newcomment.text' placeholder='Add a comment...'></textarea>
    </p>
    <p class='pull-right'>
      <button type="submit" class='btn btn-primary'>Comment</button>
    </p>
  </form>
    
    
</div>
  
<script>
var app = angular.module('ditApp');
app.controller('IssueCtrl', function($scope, $http, $sce) {
  $scope.issue = ##issue##;
  if (!$scope.issue.title) $scope.editorEnabled = true;
  if ($scope.issue._committed_on) {
    $scope.issue._committed_on_human = new Date($scope.issue._committed_on * 1000).toLocaleString();
  }
  $scope.newcomment = {
    'issue_id': $scope.issue.id,
  };
  angular.forEach($scope.issue._comments, function(comment) {
    comment._text = $sce.trustAsHtml(comment._text);
    if (comment._committed_on) {
      comment._committed_on_human = new Date(comment._committed_on * 1000).toLocaleString();
    }
  });
  
  $scope.saveTitle = function() {
    $http.post('/issue/save', $scope.issue).success(function(data) {});
  };
  $scope.addComment = function() {
    $http.post('/comment/save', $scope.newcomment).success(function(data) {
      data._text = $sce.trustAsHtml(data._text);
      $scope.issue._comments.push(data)
      $scope.newcomment.text = ''
    });
  };
  $scope.saveComment = function(comment) {
    $http.post('/comment/save', comment).success(function(data) {
      comment._text = $sce.trustAsHtml(data._text)
      comment.text = data.text
      comment._editing = false
      comment._dirty = data._dirty
    });
  };
  $scope.revert = function(o) {
    $http.post('/repo/revert', o).success(function(data) {
      if (data['_delete']) {
        $scope.issue._comments.splice($scope.issue._comments.indexOf(o),1);
      }
      else if (comment.type=='comment') {
        o._text = $sce.trustAsHtml(data._text)
        o.text = data.text
        o._editing = false
        o._dirty = data._dirty
      }
    });
  };
  $scope.commit = function(o) {
    $http.post('/repo/commit', o).success(function(data) {
      if (data.type=='comment') {
        o._text = $sce.trustAsHtml(data._text)
        o.text = data.text
        o._editing = false
        o._dirty = data._dirty
      }
    });
  };
});
</script>

