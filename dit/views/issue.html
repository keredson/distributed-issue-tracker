
<div ng-controller="IssueCtrl"> 

  <ol class="breadcrumb">
    <li><a href="/">home</a></li>
    <li><a href='/issues'>issues</a></li>
    <li class="active"><a href='/issue/{{issue.id}}'>{{issue.id}}</a></li>
  </ol>

  <h1 ng-hide="editorEnabled">
    {{issue.title}}
    <a href="#" ng-click="editorEnabled=!editorEnabled" class='glyphicon glyphicon-edit'></a>
  </h1>
  <h1 ng-show="editorEnabled">
    <form name="titleform" class='form-inline' ng-submit="saveTitle()">
      <input type="text" class='form-control' ng-model="issue.title" ng-model-options="{ updateOn: 'submit' }" name="title" size=30>
      <button type="submit" class='btn btn-primary' ng-click="titleform.title.$commitViewValue(); editorEnabled=!editorEnabled">Save</button>
      <button type="button" class='btn btn-default' ng-click="titleform.title.$rollbackViewValue(); editorEnabled=!editorEnabled">Cancel</button>
    </form>
  </h1>

  <div ng-repeat="comment in issue._comments" class="panel panel-default panel-comment">
    <div class="panel-heading">
      <span class='pull-right text-muted'>
        when
      </span>
      who
    </div>
    <div class="panel-body" ng-bind-html='comment._text'></div>
  </div>

    
  <form name="commentform" ng-submit="addComment()">
    <p>
      <textarea class='form-control' ng-model='newcomment.text' placeholder='Add a comment...'></textarea>
    </p>
    <p class='pull-right'>
      <button type="submit" class='btn btn-primary'>Comment</button>
    </p>
  </form></p>
    
    
</div>
  
<script>
var app = angular.module('ditApp');
app.controller('IssueCtrl', function($scope, $http, $sce) {
  $scope.issue = ##issue##;
  $scope.newcomment = {
    'issue_id': $scope.issue.id,
  };
  angular.forEach($scope.issue._comments, function(comment) {
    comment._text = $sce.trustAsHtml(comment._text);
  });
  
  $scope.saveTitle = function() {
    $http.post('/issue/save', $scope.issue).success(function(data) {});
  };
  $scope.addComment = function() {
    $http.post('/comment/save', $scope.newcomment).success(function(data) {
      data._text = $sce.trustAsHtml(data._text);
      $scope.issue._comments.push(data)
      $scope.newcomment.text = ''
    });
  };
});
</script>

